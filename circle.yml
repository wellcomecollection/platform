machine:
  timezone: UTC
  services:
    - docker

general:
  build_dir: terraform
  artifacts:
    - terraform.plan

dependencies:
  pre:
    - pip install awscli
    - ./tf_init.sh $INFRA_BUCKET
    - eval `aws ecr get-login`

test:
  override:
    - ./layer_config.sh $DEPLOY_ENV $IMAGE_URL
    - ./tf_plan.sh $KEY_NAME $ADMIN_CIDR `cat image.url` $INFRA_BUCKET $CIRCLE_SHA1

deployment:
  production:
    branch: master
    commands:
      - ./terraform apply terraform.plan
      - ./terraform remote push
