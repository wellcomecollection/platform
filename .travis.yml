language: scala

sudo: required

services:
  - docker

dist: trusty

branches:
  only:
    - master

# Because we have a lot of Travis jobs, we try to avoid running unnecessary
# tests and deploys.  This speeds up our builds, minimises deployment churn,
# and reduces contention on our Travis infrastructure.
#
# How we decide what to build:
#
#                   | Relevant changes | No relevant changes
#    ---------------+------------------+---------------------
#     pull request  | Run tests        | Don't run tests
#                   | Don't deploy     | Don't deploy
#    ---------------+------------------+---------------------
#     master        | Run tests        | Run tests
#                   | Deploy to AWS    | Don't deploy
#
# We always run tests on master so we get consistent build results, that's
# less important on master where results are transient.
#
# Where appropriate, we use 'exit 0' to bail out of the build early.
# See "How does this work?" in the Travis docs for why this works.
# https://docs.travis-ci.com/user/customizing-the-build/

before_install:

  - |
    SHOULD_RUN_TESTS=true
    if [[ "$TRAVIS_EVENT_TYPE" == "pull_request" ]]; then
      python3 .travis/should_run_pr_tests.py
      if (( $? == 0 )); then
        SHOULD_RUN_TESTS=false
      fi
    fi

  - |
    SHOULD_DEPLOY=false
    if [[ "$TRAVIS_EVENT_TYPE" == "push" ]]; then
      python3 .travis/should_deploy_from_master.py
      if (( $? == 1 )); then
        SHOULD_DEPLOY=true
      fi
    fi

  - |
    if [[ "$SHOULD_RUN_TESTS" == "false" ]]; then
      echo "SHOULD_RUN_TESTS is false, so exiting before running tests"
      exit 0
    fi

  - echo "SHOULD_RUN_TESTS = $SHOULD_RUN_TESTS"
  - echo "SHOULD_DEPLOY    = $SHOULD_DEPLOY"

install:
  # We need this for the Elasticsearch Docker container to start
  # See https://github.com/travis-ci/travis-ci/issues/6534
  - sudo sysctl -w vm.max_map_count=262144

cache:
  directories:
    - "~/.sbt"
    - "~/.ivy2"
    - "project/target/resolution-cache"
    - "project/target/streams"
    - "api/target"
    - "common/target"
    - "id_minter/target"
    - "ingestor/target"
    - "transformer/target"
    - "reindexer/target"
    - "/home/travis/docker/"

script:
  - .travis/run_task.sh $TASK $SHOULD_DEPLOY

env:
  global:
    - AWS_REGION=eu-west-1
    - AWS_DEFAULT_REGION=eu-west-1
    - PLATFORM_ENV=prod

    # This secure environment variable contains an encrypted version of
    # the following environment variables:
    #  * AWS_ACCESS_KEY_ID
    #  * AWS_SECRET_ACCESS_KEY
    #  * AWS_ECR_REPO
    #  * CONFIG_BUCKET
    - secure: Pet60dG/PQe1O2/zYQutmbvNKSQdLwEyfHnp4aSbzOoqADR08AOTA6CrMswv+Zs4qBHzxeXAMxgkFM0UpXdNPlw/HQ4FAhstStJFVkoPhWSo5/rbZutkOtWtgBI2+wD/Z0t4n7Tq2h0tW2+IvG/4kCG7qbp6VYOzw1yZzHhT/E2j/S7J/YFTYzMpsYpA35192XMqdzg7dygzUiC+yeYMps4iu4UkbCgAJ19h9vT68E5IpCOyTai4P7HAFiLQ9p+5465g1whU+U0JMWEktGLCjGCblNGnr8YyIh/+IUUue9Kagkr8PXh22OM3/rhsBAgg5qeNO0sujcBq0WJH1dyAFV56Vn/smZS/cQ3EqXg2knfcZWKMHXKLqqdOy4jcPg9A6NIlBnwpC8nC085OpYrnMyyPwaBMg2OpF+Rr6xFzLDglHYmPuO74yJSPqakkLyJbdHDZ4VPOEKseOCWdBaBo8rJXzL9AProDRpFkeA4onpqgFNt5pbY4judgklnnBZLAqk9lCfotk2YCTyHxKJ1X5XV+N9zvPRvD/c/8dMm9VqVKHyuxS71hOPL9y5B+1zYACxbVxgc/Qw/UklOGduaLDPPOtyuTsE59c98lXpFCk/f0txM0CLxQA4pjGQ9x6apx8Eyr5D3I/bAvascujAtMWdtGjd2x4Ez454Huy/krQpE=
  matrix:
    - TASK=check-format
    - TASK=sbt-test-common
    - TASK=sbt-test-api
    - TASK=sbt-test-transformer
    - TASK=sbt-test-ingestor
    - TASK=sbt-test-id_minter
    - TASK=sbt-test-reindexer
    - TASK=lambdas-test
    - TASK=nginx-build
    - TASK=tif-metadata-build
    - TASK=gatling-build
    - TASK=loris-build
    - TASK=miro_adapter-test
    - TASK=elasticdump-build
    - TASK=api_docs-build
    - TASK=miro_preprocessor-test
