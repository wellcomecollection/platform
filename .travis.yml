language: sh

sudo: required

services:
  - docker

dist: trusty

branches:
  only:
    - master

cache:
  directories:
    - $HOME/.sbt
    - $HOME/.ivy2/cache
    - project/target
    - target

# Based on instructions from
# https://www.scala-sbt.org/1.0/docs/Travis-CI-with-sbt.html#Caching
before_cache:
  - sudo find $HOME/.ivy2/cache -name "ivydata-*.properties" -print -delete
  - sudo find $HOME/.sbt        -name "*.lock"               -print -delete

script:
  - ./run_travis_task.py

env:
  global:
    # This forces Python to print everything to stdout/stderr immediately.
    # Otherwise, we've seen issues where all the output from our Travis scripts
    # gets buffered, and only gets printed at the end of the test...
    #
    # ... out of order from the rest of the rest of the output!
    #
    # See also: https://docs.python.org/3/using/cmdline.html#cmdoption-u
    #
    - PYTHONUNBUFFERED=x

jobs:
  include:
    - stage: quicktest
      env: TASK=travis-format

    # Lambda tests.
    #
    # We test all the Lambdas in a single job to reduce the number of small
    # build VMs we start.  Because most of our applications are Scala, the
    # majority of builds for a Lambda wake up, discover they have nothing to
    # do, and exit immediately.
    #
    # This includes all the tests for monitoring and shared_infra stacks.
    #
    # When this job runs, all the Lambdas get tested at once, but even this
    # isn't significantly longer than a Scala test.

    - stage: test
      env:
        - TRAVIS_LAMBDAS="
          lambdas/drain_ecs_container_instance \
          lambdas/dynamo_write_heartbeat \
          lambdas/ecs_ec2_instance_tagger \
          post_to_slack \
          update_service_list"
        - TASK=travis-lambda-test

    # (not under active development)

    # nginx stack
    # - env: TASK=nginx-build

    # Loris stack
    # - env: TASK=loris-build
    # - env: TASK=cache_cleaner-build

stages:
  - quicktest
  - test
