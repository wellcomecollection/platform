language: sh

sudo: required

services:
  - docker

dist: trusty

branches:
  only:
    - master

script:
  # Wait 45 minutes for the entire build to finish.
  - travis_wait 45 ./run_travis.sh

jobs:
  include:
    - stage: preflight
      env: TASK=travis-format

    - stage: infrastructure
      env: TASK=ecs_ec2_instance_tagger-test

    - stage: reporting
      env: TASK=reporting_miro_transformer-test
    - env: TASK=reporting_miro_inventory_transformer-test
    - env: TASK=reporting_sierra_transformer-test
    - env: TASK=reporting_calm_transformer-test

    - stage: nginx-build
      env: TASK=nginx-build

    - stage: nginx-publish
      env: TASK=nginx-publish

#    - stage: loris
#      env: TASK=loris-build

stages:
  - name: preflight

  - name: shared_lambdas

  - name: reporting

  - name: nginx-build
    if: branch != master

  - name: nginx-publish
    if: branch = master

