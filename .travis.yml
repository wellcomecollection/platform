language: scala

sudo: required

dist: trusty

# Install Docker on Travis.  Merely exposing Docker through the Travis
# settings is insufficient, because the docker-compose tests we use are
# unable to see it in that case.
install:
  - sudo sysctl -w vm.max_map_count=262144
  - curl -sSL "https://get.docker.com/gpg" | sudo -E apt-key add -
  - echo "deb https://apt.dockerproject.org/repo ubuntu-trusty main" | sudo tee -a /etc/apt/sources.list
  - sudo apt-get update
  - sudo apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" --assume-yes install docker-engine
  - docker version

cache:
  directories:
    - "~/.sbt"
    - "~/.ivy2"
    - "project/target/resolution-cache"
    - "project/target/streams"
    - "api/target"
    - "calm_adapter/target"
    - "common/target"
    - "id_minter/target"
    - "ingestor/target"
    - "transformer/target"

matrix:
  include:
    - env: PROJECT=common
    - env: PROJECT=api
    - env: PROJECT=transformer
    - env: PROJECT=calm_adapter
    - env: PROJECT=ingestor
    - env: PROJECT=id_minter

script:
  # https://graysonkoonce.com/getting-the-current-branch-name-during-a-pull-request-in-travis-ci/
  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
  - echo "TRAVIS_BRANCH=$TRAVIS_BRANCH, PR=$PR, BRANCH=$BRANCH"
  - sbt "project $PROJECT" dockerComposeUp
  - sbt "project $PROJECT" test
  - sbt "project $PROJECT" dockerComposeStop
  - >
    if [[ "$BRANCH" == "master" ]];
    then
      if [[ "$PROJECT" != "common" ]]; then
        sbt "project $PROJECT" -DconfigBucket=$CONFIG_BUCKET -Denv=$BUILD_ENV ecr:push;
      fi;
    else
      echo "Not on master; skipping deploy...";
    fi

env:
  global:
    secure: DlAiZ4pqJvutslMRUbI5o4Xk73GLd0ab2e8zko8J0VgMFKu3UGzK17UDzx2qXgMcrHLY3i5wtHHTOO+WpK+GTTRUEEmv9Eg+FHpsqpdN1yMXfGyZaw3oadMsPoVLfq7UlxFdubbYi05jIZt8th4HHIRQz2xIxyOH0lrrjeeFsnPlHQz0P+vSklCKYOHZh3+w4lsmhGwxPRHDsKDYJXMyd4et1Cy5mV3yl620Y0oHmwEPANZt7oX2Fvs7kkBiBAJB4Mt8n22uDjZ78D00ix+yWP9LIGWfNwelv4x+W887I0E6K/r2ncU+hpInShsXmhKhtjS3u6wNgxkzzwBDQ3MMmwVkmwnyGUq0TNZUfde8x4mdHrlK/szL6Q+DLSt9u/Rg2BOvHrrGqasboRl8o44qe+Bk2NsjgEYxlA078ynbbZPOH+5+sf3aZSN01gP8xm9t+lJc5AEVDePENOu910vb53t8fStWQED53FrOjVtt9AnVw+iVlvurvx3jSBFtbo0XrcED5FSW/ysi+JNBB2rXzDGn7aznWSKguu768oEJ06DcikddSmarkxoaxCTE4sYGz/cCgBUebAJBlq5C8aBAYQefZ1Bgh1KdmxDpZbFzWaUOdLxFczyrYS4t7hkQLn+9CeWtlXppuPGQGUFeMulHyptlqJt49bWuAgYPsSxr0yE=
