language: sh

sudo: required

services:
  - docker

dist: trusty

branches:
  only:
    - master

script:
  # Wait 45 minutes for the entire build to finish.
  - travis_wait 45 ./run_travis.sh

jobs:
  include:
    - stage: preflight
      env: TASK=travis-format

    # Lambda tests.
    #
    # We test all the Lambdas in a single job.
    # This reduces the number of VMs we start.
    - stage: test
      env:
        - TRAVIS_LAMBDAS="
          lambdas/drain_ecs_container_instance \
          lambdas/dynamo_write_heartbeat \
          lambdas/ecs_ec2_instance_tagger \
          post_to_slack \
          update_service_list"
        - TASK=travis-lambda-test

    # (not under active development)

    # nginx stack
    # - env: TASK=nginx-build

    # Loris stack
    # - env: TASK=loris-build
    # - env: TASK=cache_cleaner-build

stages:
  - quicktest
  - test
